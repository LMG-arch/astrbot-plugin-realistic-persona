# 拟人化角色行为系统插件

## 功能特性

这是一个为AstrBot打造的综合性拟人化角色行为系统插件，整合了多个模块以实现真实可信的AI角色体验。

### 核心功能

1. **情绪感知系统**
   - 自动检测用户情绪（开心、悲伤、兴奋、生气等10种情绪）
   - 根据情绪自动调整回复风格
   - 情绪趋势分析
   - **真人自拍功能**：
     - 在开心、兴奋等情绪时自动触发真人自拍
     - 生成真实人类自拍效果，而非AI生成图像
     - 根据当前情绪状态生成相应的自拍提示词
     - 保持真实感和自然感

2. **生活模拟系统**
   - **详细日程生成**：包含8个时间段的具体安排
   - **智能穿搭生成**：
     - 自动获取当地实时天气
     - 根据天气情况选择合适穿着（雨天带伞、寒冷加厚、高温轻薄）
     - 结合人设和当天活动生成符合角色的穿搭
   - **使用系统人设**：自动从AstrBot系统设置中获取默认人设，无需单独配置
   - **图片一致性**：生成的图片人物穿着与日程保持一致
   - 模拟真实的作息时间
   - 根据时间段调整行为状态
   - **使用天气工具**实时查询当地天气
   - **使用联网工具**每天早上获取当天早间新闻（默认7点，可自定义）
   - 新闻学习与知识积累

3. **AI绘图功能**
   - 集成ModelScope文生图API
   - 支持LLM工具调用生成图片
   - 命令方式快速生成
   - 多种图片尺寸支持

4. **QQ空间日记系统**（可选）
   - 自动生成并发布QQ空间说说
   - AI自动配图（基于ModelScope）
   - 定时任务支持
   - 基于群聊内容的日记生成
   - 支持评论回复功能

5. **上下文事件管理**
   - 对话事件检测（问候、话题切换等）
   - 主动消息发送
   - 会话状态管理

## 安装使用

1. 确保AstrBot版本 >= 4.1.0

2. 安装插件依赖：
```bash
pip install -r requirements.txt
```

3. 配置插件：
   - `api_key`: ModelScope API密钥（必需）
   - `persona_name`: 角色名称
   - `persona_profile`: 角色人设描述
   - `weather_location`: 天气查询位置
   - 其他配置项请参考配置页面

4. 启用所需功能模块

## 命令列表

### AI绘图
- `/aiimg <提示词>` - 命令方式生成图片
- `/emotion_status` - 查看当前情绪状态

### QQ空间功能（需启用enable_qzone）
- `/发说说 <内容> [图片]` - 手动发布说说（管理员）
- `/写说说 [主题] [图片]` - AI生成说说内容并自动配图

## LLM工具

插件注册了 `draw` 工具，AI可以主动调用生成图片：
- 根据对话情绪和上下文自动生成图片
- 支持情绪自拍
- 自适应场景描述

## 配置说明

### AI绘图配置
- `api_key`: ModelScope API密钥
- `model`: 使用的模型名称
- `size`: 默认图片尺寸

### 情绪感知配置
- `enable_emotion_detection`: 是否启用情绪检测
- `enable_auto_selfie`: 是否启用自动自拍
- `selfie_trigger_chance`: 自拍触发概率

### 生活模拟配置
- `enable_life_simulation`: 是否启用生活模拟
- `persona_name`: 角色名称（用于日程生成等场景）
- `schedule_hour`: 日程生成时间
- `news_hour`: 早间新闻获取时间（默认7点，可自定义）
- `weather_location`: 天气查询位置（需配合天气工具使用）
- `news_topics`: 关注话题列表（需配合联网工具获取真实新闻）

**注意**：角色人设将从AstrBot系统设置中自动获取，无需在此插件中单独配置。

### QQ空间配置
- `enable_qzone`: 是否启用QQ空间功能
- `publish_times_per_day`: 每天发布次数（默认1次）
- `publish_time_ranges`: 发布时间段列表（默认["9-12", "14-18", "19-22"]）
- `insomnia_probability`: 失眠发说说概率（0-1之间，默认0.2即20%）
- `diary_max_msg`: 日记最大消息数
- `diary_prompt`: 日记生成提示
- `comment_prompt`: 评论生成提示

## 技术特性

- 符合AstrBot插件开发规范
- 模块化设计，功能可独立启用/禁用
- 异步编程，性能优化
- 完善的错误处理
- 支持热重载

## 优化说明

### Token优化

本插件已经进行了全面的Token优化，大幅减少LLM API调用成本：

1. **缓存机制**：
   - 天气数据缓存1小时，避免重复查询
   - 新闻数据每天缓存一次
   - 日程安排每天缓存一次

2. **精简提示词**：
   - 大幅缩减系统提示词长度，保留核心信息
   - 天气/新闻查询提示词从长段落精简至一句话
   - 日程生成提示词优化，减少冗余描述

3. **条件性加载**：
   - 只在有数据时才添加到系统提示
   - 未配置天气位置时不查询天气
   - 早于设定时间不获取新闻/日程

### 发说说功能增强

1. **灵活的时间配置**：
   - 支持每天多次发布，可自由设置次数
   - 支持多个时间段，系统随机分配
   - 更符合真实人类发说说的习惯

2. **失眠随想功能**：
   - 模拟真实的晚上失眠场景
   - 23:00-02:00之间每30分钟检查一次
   - 按配置概率随机触发
   - 使用专门的“失眠随想”主题生成内容

3. **智能计数**：
   - 每天自动重置发布计数
   - 失眠发布不计入每日限额
   - 达到每日限额后自动跳过

1. QQ空间功能需要aiocqhttp平台支持
2. 需要有效的ModelScope API密钥才能使用绘图功能
3. 建议合理设置各项概率和时间参数，避免过于频繁
4. pillowmd依赖可选，如不使用QQ空间功能可不安装
5. **生活模拟功能需要启用天气工具和联网工具**以获取真实数据：
   - 天气工具：用于查询实时天气信息
   - 联网工具：用于每天早上获取当天早间新闻（默认7点，可通过news_hour配置）
   - 如果这些工具未启用，系统会回退到基础功能
6. **自拍功能说明**：插件中提到的“自拍”指真人自拍照片，不是AI生成的图像

## 版本历史

- v1.0.0: 首个整合版本，合并了ms_aiimg和qzone插件的所有功能
  - 删除了校园墙功能（投稿、看稿、过稿、拒稿、删稿）
  - 删除了读说说功能（查看说说、点赞评论说说）
  - 保留了自动配图写说说功能
  - 支持评论回复功能
  - 使用天气工具获取实时天气
  - 使用联网工具每天早上获取当天早间新闻（默认7点，可配置）
  - 明确自拍功能指真人自拍，不是AI生成
- v1.1.0: Token优化和发说说功能增强
  - **Token大幅优化**：添加缓存机制，精简提示词，条件性加载
  - **灵活发布计划**：支持每天多次发布，可自定义时间段
  - **失眠随想功能**：23:00-02:00随机发失眠说说
  - 移除旧的Cron配置，使用更灵活的时间段配置
- v1.2.0: 日程详细化和图片一致性增强
  - **详细日程**：日程分为8个时间段，包括具体活动安排
  - **智能穿搭**：自动获取当地实时天气，根据天气情况生成合适穿着
  - **图片一致性**：AI生成图片时会自动保持人物穿着与日程一致
  - 增强角色形象的连贯性和真实性
- v1.3.0: 真人自拍功能优化
  - **真实自拍**：在开心、兴奋等情绪时生成真人自拍效果
  - **情绪匹配**：根据当前情绪状态生成相应的自拍提示词
  - **真实感增强**：强调真实人类自拍，而非AI生成图像
- v1.4.0: 使用系统人设
  - **系统人设集成**：自动从AstrBot系统设置中获取默认人设
  - **配置简化**：无需在插件中单独设置角色人设
  - **一致性增强**：与全局人设保持同步
- v1.5.0: 终端日志增强
  - **详细日志输出**：在关键功能点添加终端日志
  - **情绪检测日志**：显示检测到的情绪和处理过程
  - **调度器日志**：显示任务调度和执行情况
  - **生活模拟日志**：显示日程、新闻、天气生成过程
- v1.5.1: Bug修复
  - **修复事件处理错误**：修正ContextEvent对象属性访问错误
- v1.6.0: 图文并茂功能增强
  - **图片+文字组合**：draw工具现在支持同时发送图片和文字回复
  - **QQ空间图文**：自动发布说说时确保图文并茂
  - **智能内容匹配**：图片生成时自动关联相应的文字内容
- v1.6.1: 自然回复优化
  - **自然文字回复**：根据图片内容生成更自然的文字描述
  - **上下文感知**：识别图片关键词并生成相应回复（如"在做实验呢"、"在学习呢"等）
  - **情感匹配**：回复风格与图片内容相匹配
- v1.6.2: Bug修复
  - **修复LLM钩子错误**：修正on_llm_request_handler方法参数错误
- v1.6.3: 图文并茂增强
  - **确保消息发送**：修复draw工具调用后消息发送问题，确保图片和文字同时发送给用户
- v1.6.4: 对话流程优化
  - **分离工具调用和对话**：优化draw工具，使AI可在发送图片后继续自然对话
- v1.6.5: AI自主对话增强
  - **AI自主回复**：移除系统内置回复，让AI根据图片内容自然生成对话回复
- v1.6.6: Bug修复
  - **修复LLM钩子参数错误**：修正on_llm_request_handler方法参数数量问题
- v1.6.7: 图片发送优化
  - **纯图片发送**：优化draw工具，只发送图片不添加任何文字
- v1.6.8: 数据缓存优化
  - **缓存生活数据**：日程、新闻、天气数据当天缓存，避免重复生成
- v1.6.9: 天气获取优化
  - **优化天气查询**：优先使用wttr.in服务，提高天气数据准确性
- v1.6.10: 自动发布修复
  - **修复自动发布**：使用正确的配置项检查自动发布功能
- v1.6.11: 自动配图确认
  - **确认自动配图**：自动发布说说时会自动生成相关配图
- v1.6.12: 日程生成优化
  - **增强错误处理**：优化日程生成的错误处理机制，提高稳定性
- v1.6.13: 错误处理强化
  - **增强插件稳定性**：确保插件错误不影响LLM请求流程
- v1.6.14: 时间段支持增强
  - **支持精确时间段**：可设置具体时间段如20:00-20:20
- v1.6.15: 调试增强
  - **添加调试日志**：添加配置检查日志以帮助诊断问题

## 致谢

本插件整合了以下插件的功能：
- astrbot_plugin_ms_aiimg (竹和木)
- astrbot_plugin_qzone
