# 拟人化角色行为系统插件

## 功能特性

这是一个为AstrBot打造的综合性拟人化角色行为系统插件，整合了多个模块以实现真实可信的AI角色体验。

### 核心功能

1. **情绪感知系统**
   - 自动检测用户情绪（开心、悲伤、兴奋、生气等10种情绪）
   - 根据情绪自动调整回复风格
   - 情绪趋势分析
   - **真人自拍功能**：
     - 在开心、兴奋等情绪时自动触发真人自拍
     - 生成真实人类自拍效果，而非AI生成图像
     - 根据当前情绪状态生成相应的自拍提示词
     - 保持真实感和自然感

2. **生活模拟系统**
   - **详细日程生成**：包含8个时间段的具体安排
   - **智能穿搭生成**：
     - 自动获取当地实时天气
     - 根据天气情况选择合适穿着（雨天带伞、寒冷加厚、高温轻薄）
     - 结合人设和当天活动生成符合角色的穿搭
   - **使用系统人设**：自动从AstrBot系统设置中获取默认人设，无需单独配置
   - **图片一致性**：生成的图片人物穿着与日程保持一致
   - 模拟真实的作息时间
   - 根据时间段调整行为状态
   - **使用天气工具**实时查询当地天气
   - **独立新闻获取模块**：支持多源容错和智能降级
     - 优先从百度新闻、必应新闻等在线源获取
     - 如果所有源都失败，自动回退到LLM联网搜索
     - 本地缓存机制，避免重复获取
   - **使用联网工具**每天早上获取当天早间新闻（默认7点，可自定义）
   - 新闻学习与知识积累

3. **AI绘图功能**
   - 集成ModelScope文生图API
   - 支持LLM工具调用生成图片
   - **绘画提示词多源信息融合**：
     - 自动结合人设、天气、日程、穿着信息
     - 根据时间自动调整光线描述
     - 保持图片与角色生活一致性
   - **绘画历史记录**：
     - 自动保存每次绘画提示词到本地
     - 对话时参考历史绘画内容
     - 避免重复生成，提升多样性
   - 命令方式快速生成
   - 多种图片尺寸支持

4. **QQ空间日记系统**（可选）
   - 自动生成并发布QQ空间说说
   - **AI自动配图增强**：
     - 基于Mod elScope的智能配图
     - **对话上下文集成**：可配置从指定用户的私聊历史生成内容
     - 结合对话历史生成更贴合情境的配图
     - 让图文内容更加一致
   - 定时任务支持
   - 基于群聊/私聊内容的日记生成
   - 支持评论回复功能

5. **上下文事件管理**
   - 对话事件检测（问候、话题切换等）
   - 主动消息发送
   - 会话状态管理

7. **基于情绪的个人资料自动更新系统**
   - **自动更换昵称**：根据当前情绪状态自动生成并更新 QQ 昵称
   - **自动更换签名**：根据情绪自动生成个性签名（支持表情符号）
   - **自动更换头像**：使用 AI 绘图根据情绪生成真实风格的头像并自动更换
   - **情绪强度检测**：只有当情绪强度达到阈值时才触发更新
   - **冷却机制**：防止频繁更新，可自定义更新间隔
   - **本地状态管理**：记录更新历史和情绪记录

8. **异步思考循环系统** (可选)
   - **后台不断思考**：即使不处于对话中，插件也持续产生思考
     - 每隔 15-30 分钟自动产生一条上你的状态
     - 模拟日常活动："刚泡了杯虚拟咖啡、在窗边发了会儿呆"
   - **经历累积**：所有对话、事件都会被记录为"人生经历"
   - **成长追踪**：技能、兴趣、观点会随时间演化
   - **关系网络**：记住每个用户的互动模式，形成差异化关系
   - **时间感知**：基于时间、天气、节日触发内心独白
   - **本地文件保存**：所有思考、活动、经历信息存储到本地 JSON/JSONL 文件

9. **人格演化系统** (可选)
   - **自我认知系统**：维护角色的自我描述与实际行为一致性
     - 记录行为并检查一致性
     - 自我描述随着经历自然演化
     - 渐进式特质演化，避免人格突变
   - **表达风格演进**：管理词汇、幽默感、句式复杂度的成长
     - 词汇库扩展：从内容中学习新词汇
     - 幽默感成熟：根据笑话效果提升能力
     - 句式复杂度提升
   - **习惯与变化的平衡**：管理稳定性与新鲜感
     - 核心习惯：永久保持的标志性特征
     - 临时习惯：会演化的新元素
     - 变化节奏控制：14天稳定期 + 7天变化期交替
     - 惊喜频率控制：24小时最多3次，间隔≥6小时
   - **命令支持**：`/personality_status` - 查看人格演化状态

10. **人生故事引擎** - 最小化Token消耗同时保证高质量扮演
   - **基于原始人设，自动补充经历线**：
     - 永不修改原始人设，只丰富背景和经历细节
     - 从经历银行、思考引擎自动收集数据
     - 使用LLM构建完整的人生故事章节
   - **智能精简上下文生成**：
     - 将完整的人生故事压缩为极简的上下文提示（目标<200字）
     - 使用LLM智能提取核心信息
     - 缓存7天，减少重复生成
   - **定期自动更新**：
     - 默认3天自动更新一次经历线（可配置）
     - 后台异步执行，不影响当前对话
   - **上下文自动注入**：
     - 每次LLM请求时自动注入精简上下文
     - 无需手动干预，全自动化
   - **设计目标**：
     - 优先保证扮演质量（人设一致性、经历完整性）
     - 其次优化Token消耗（精简压缩、缓存重用）
     - 根据实际经历构建故事，而非根据用户习惯

## 安装使用

1. 确保AstrBot版本 >= 4.1.0

2. 安装插件依赖：
```bash
pip install -r requirements.txt
```

3. 配置插件：
   - `api_key`: ModelScope API密钥（必需）
   - `persona_name`: 角色名称
   - `persona_profile`: 角色人设描述
   - `weather_location`: 天气查询位置
   - 其他配置项请参考配置页面

4. 启用所需功能模块

## 命令列表

### AI绘图
- `/aiimg <提示词>` - 命令方式生成图片
- `/emotion_status` - 查看当前情绪状态
- `/personality_status` - 查看人格演化状态（需启用异步思考系统）

### QQ空间功能（需启用enable_qzone）
- `/发说说 <内容> [图片]` - 手动发布说说（管理员）
- `/写说说 [主题] [图片]` - AI生成说说内容并自动配图

## LLM工具

插件注册了 `draw` 工具，AI可以主动调用生成图片：
- 根据对话情绪和上下文自动生成图片
- 支持情绪自拍
- 自适应场景描述

## 配置说明

### AI绘图配置
- `api_key`: ModelScope API密钥
- `model`: 使用的模型名称
- `size`: 默认图片尺寸
- `image_forbidden_rules`: **绘画禁止规则**（可配置）
  - 生成图片时的强制约束规则
  - 会被添加到所有绘画提示词中
  - 默认：
  - 留空则不添加任何禁止规则
  - 支持完全自定义，可根据需求设置不同的约束

### 情绪感知配置
- `enable_emotion_detection`: 是否启用情绪检测
- `enable_auto_selfie`: 是否启用自动自拍
- `selfie_trigger_chance`: 自拍触发概率（默认0.3即30%，建议0.2-0.5）

### 生活模拟配置
- `enable_life_simulation`: 是否启用生活模拟
- `persona_name`: 角色名称（用于日程生成等场景）
- `schedule_hour`: 日程生成时间
- `news_hour`: 早间新闻获取时间（默认7点，可自定义）
- `weather_location`: 天气查询位置（需配合天气工具使用）
- `news_topics`: 关注话题列表（需配合联网工具获取真实新闻）

**注意**：角色人设将从AstrBot系统设置中自动获取，无需在此插件中单独配置。

### QQ空间配置
- `enable_qzone`: 是否启用QQ空间功能
- `publish_times_per_day`: 每天发布次数（默认3次，建议2-5次较为自然）
- `publish_time_ranges`: 发布时间段列表（默认["9-12", "14-18", "19-22"]）
  - 支持小时范围格式："9-12"、"14-18"
  - 也支持精确时间格式："20:00-20:20"
- `insomnia_probability`: 失眠发说说概率（0-1之间，默认0.15即15%，建议0.1-0.3）
- `diary_max_msg`: 日记最大消息数
- `diary_user_id`: **优先使用的对话用户ID**
  - 填写QQ号，发说说时优先从该用户的私聊历史生成内容
  - 留空则从群聊读取
  - **配图也会参考该用户的对话历史**，让图文更一致
- `diary_prompt`: 日记生成提示（可自定义，默认为口语化、简洁风格）
- `comment_prompt`: 评论生成提示（可自定义）
- `schedule_prompt`: 日程生成提示词（可自定义）
- `news_prompt`: 新闻获取提示词（可自定义）
- `enable_news_getter`: 是否启用新闻获取模块（默认true）
  - 是否使用独立的新闻获取模块（支持多源容错），而非仅依赖LLM联网功能
- `news_online_fetch`: 是否启用联网获取新闻（默认true）
  - 是否主动从多个新闻源获取实时新闻数据

### 个人资料自动更新配置

**前置条件**：需要先启用`enable_auto_profile_update=true`，才能看到其他配置项

- `enable_auto_profile_update`: 是否启用基于情绪的个人资料自动更新（默认false）
- `enable_auto_nickname`: 是否自动修改昵称（默认false，依赖enable_auto_profile_update）
- `enable_auto_signature`: 是否自动修改签名（默认true，依赖enable_auto_profile_update）
- `enable_auto_avatar`: 是否自动生成并更换头像（默认false，依赖enable_auto_profile_update）
- `profile_update_cooldown`: 更新冷却时间（默认1800秒，即30分钟，依赖enable_auto_profile_update）
  - 两次更新之间的最小间隔时间
- `emotion_change_threshold`: 情绪变化阈值（默认0.6，范围0-1，依赖enable_auto_profile_update）
  - 触发更新的情绪强度阈值，越高越不容易触发

**注意**：
- 昵称和头像更新频率建议保持较低，避免对用户造成困扰
- 签名更新相对轻量，可以更频繁更新以展示当前情绪状态
- 头像生成需要 ModelScope API，会消耗一定的 API 配额
- 所有更新都会记录到本地状态文件中

### 人生故事引擎配置

**前置条件**：需要先启用`enable_async_thinking=true`，才能看到人生故事引擎的配置项

- `enable_life_story`: 是否启用人生故事引擎（默认true，依赖enable_async_thinking）
- `life_story_update_interval`: 更新间隔（天），默认3天
  - 故事引擎多久生成/更新一次人生经历补充
- `life_story_collect_days`: 收集经历范围（天），默认7天
  - 生成故事时从经历银行收集最近多少天的数据
- `life_story_context_max_length`: 精简上下文最大长度（字符），默认200，范围100-500
  - LLM对话中注入的精简上下文最大字符数
- `life_story_cache_days`: 上下文缓存有效期（天），默认7天
  - 生成的精简上下文缓存多久才需要重新生成

**说明**：
- 人生故事引擎基于原始人设，自动构建完整的人生经历线
- 原始人设一经设置永不更改，只丰富背景经历
- 自动从经历银行、思考引擎、事件系统收集数据
- 将完整故事压缩为精简提示，最小化Token消耗
- 缓存机制避免重复生成，后台异步更新不影响对话
- 每次LLM请求时自动将精简上下文注入system_prompt

### 异步思考系统配置
- `enable_async_thinking`: 是否启用异步思考循环（默认true）
  - 支持后台不断进行思考、活动记录、经历累积等功能
  - 对话、事件会自动记录到本地文件
  - 技能、兴趣、观点会随时间演变
  - 包含人格演化系统，实现自我认知、表达演进、习惯平衡等功能

## 技术特性

- 符合AstrBot插件开发规范
- 模块化设计，功能可独立启用/禁用
- 异步编程，性能优化
- 完善的错误处理
- 支持热重载

## 优化说明

### 调试增强

本插件在v1.7.1版本增加了完整的调试日志系统：

1. **绘图工具追踪**：
   - 工具调用日志：显示提示词、尺寸、配置状态
   - 请求进度日志：开始请求、生成成功、发送状态
   - 错误详情日志：当API失败时显示完整错误信息
   - 配置检查日志：显示api_key和llm_tool_enabled状态

2. **问题诊断工具**：
   - QQ空间模块诊断脚本：`diagnose_qzone.py`
   - 自动配置脚本：`setup_qzone_config.py`
   - 完整启用指南：`enable_qzone_guide.md`

### Token优化

本插件已经进行了全面的Token优化，大幅减少LLM API调用成本：

1. **缓存机制**：
   - 天气数据缓存1小时，避免重复查询
   - 新闻数据每天缓存一次
   - 日程安排每天缓存一次

2. **精简提示词**：
   - 大幅缩减系统提示词长度，保留核心信息
   - 天气/新闻查询提示词从长段落精简至一句话
   - 日程生成提示词优化，减少冗余描述

3. **条件性加载**：
   - 只在有数据时才添加到系统提示
   - 未配置天气位置时不查询天气
   - 早于设定时间不获取新闻/日程

### 发说说功能增强

1. **灵活的时间配置**：
   - 支持每天多次发布，可自由设置次数
   - 支持多个时间段，系统随机分配
   - 更符合真实人类发说说的习惯

2. **失眠随想功能**：
   - 模拟真实的晚上失眠场景
   - 23:00-02:00之间每30分钟检查一次
   - 按配置概率随机触发
   - 使用专门的“失眠随想”主题生成内容

3. **智能计数**：
   - 每天自动重置发布计数
   - 失眠发布不计入每日限额
   - 达到每日限额后自动跳过

1. QQ空间功能需要aiocqhttp平台支持
2. 需要有效的ModelScope API密钥才能使用绘图功能
3. 建议合理设置各项概率和时间参数，避免过于频繁
4. pillowmd依赖可选，如不使用QQ空间功能可不安装
5. **生活模拟功能需要启用天气工具和联网工具**以获取真实数据：
   - 天气工具：用于查询实时天气信息
   - 联网工具：用于每天早上获取当天早间新闻（默认7点，可通过news_hour配置）
   - 如果这些工具未启用，系统会回退到基础功能
6. **自拍功能说明**：插件中提到的“自拍”指真人自拍照片，不是AI生成的图像

## 版本历史

- v1.0.0: 首个整合版本，合并了ms_aiimg和qzone插件的所有功能
  - 删除了校园墙功能（投稿、看稿、过稿、拒稿、删稿）
  - 删除了读说说功能（查看说说、点赞评论说说）
  - 保留了自动配图写说说功能
  - 支持评论回复功能
  - 使用天气工具获取实时天气
  - 使用联网工具每天早上获取当天早间新闻（默认7点，可配置）
  - 明确自拍功能指真人自拍，不是AI生成
- v1.1.0: Token优化和发说说功能增强
  - **Token大幅优化**：添加缓存机制，精简提示词，条件性加载
  - **灵活发布计划**：支持每天多次发布，可自定义时间段
  - **失眠随想功能**：23:00-02:00随机发失眠说说
  - 移除旧的Cron配置，使用更灵活的时间段配置
- v1.2.0: 日程详细化和图片一致性增强
  - **详细日程**：日程分为8个时间段，包括具体活动安排
  - **智能穿搭**：自动获取当地实时天气，根据天气情况生成合适穿着
  - **图片一致性**：AI生成图片时会自动保持人物穿着与日程一致
  - 增强角色形象的连贯性和真实性
- v1.3.0: 真人自拍功能优化
  - **真实自拍**：在开心、兴奋等情绪时生成真人自拍效果
  - **情绪匹配**：根据当前情绪状态生成相应的自拍提示词
  - **真实感增强**：强调真实人类自拍，而非AI生成图像
- v1.4.0: 使用系统人设
  - **系统人设集成**：自动从AstrBot系统设置中获取默认人设
  - **配置简化**：无需在插件中单独设置角色人设
  - **一致性增强**：与全局人设保持同步
- v1.5.0: 终端日志增强
  - **详细日志输出**：在关键功能点添加终端日志
  - **情绪检测日志**：显示检测到的情绪和处理过程
  - **调度器日志**：显示任务调度和执行情况
  - **生活模拟日志**：显示日程、新闻、天气生成过程
- v1.5.1: Bug修复
  - **修复事件处理错误**：修正ContextEvent对象属性访问错误
- v1.6.0: 图文并茂功能增强
  - **图片+文字组合**：draw工具现在支持同时发送图片和文字回复
  - **QQ空间图文**：自动发布说说时确保图文并茂
  - **智能内容匹配**：图片生成时自动关联相应的文字内容
- v1.6.1: 自然回复优化
  - **自然文字回复**：根据图片内容生成更自然的文字描述
  - **上下文感知**：识别图片关键词并生成相应回复（如"在做实验呢"、"在学习呢"等）
  - **情感匹配**：回复风格与图片内容相匹配
- v1.6.2: Bug修复
  - **修复LLM钩子错误**：修正on_llm_request_handler方法参数错误
- v1.6.3: 图文并茂增强
  - **确保消息发送**：修复draw工具调用后消息发送问题，确保图片和文字同时发送给用户
- v1.6.4: 对话流程优化
  - **分离工具调用和对话**：优化draw工具，使AI可在发送图片后继续自然对话
- v1.6.5: AI自主对话增强
  - **AI自主回复**：移除系统内置回复，让AI根据图片内容自然生成对话回复
- v1.6.6: Bug修复
  - **修复LLM钩子参数错误**：修正on_llm_request_handler方法参数数量问题
- v1.6.7: 图片发送优化
  - **纯图片发送**：优化draw工具，只发送图片不添加任何文字
- v1.6.8: 数据缓存优化
  - **缓存生活数据**：日程、新闻、天气数据当天缓存，避免重复生成
- v1.6.9: 天气获取优化
  - **优化天气查询**：优先使用wttr.in服务，提高天气数据准确性
- v1.6.10: 自动发布修复
  - **修复自动发布**：使用正确的配置项检查自动发布功能
- v1.6.11: 自动配图确认
  - **确认自动配图**：自动发布说说时会自动生成相关配图
- v1.6.12: 日程生成优化
  - **增强错误处理**：优化日程生成的错误处理机制，提高稳定性
- v1.6.13: 错误处理强化
  - **增强插件稳定性**：确保插件错误不影响LLM请求流程
- v1.6.14: 时间段支持增强
  - **支持精确时间段**：可设置具体时间段如20:00-20:20
- v1.6.15: 调试增强
  - **添加调试日志**：添加配置检查日志以帮助诊断问题
- v1.6.16: 评论回复增强
  - **自动回复评论**：添加自动检查并回复说说评论的功能
- v1.6.17: 诊断增强
  - **增强调试信息**：添加更多配置诊断日志
- v1.6.18: 情绪系统修复
  - **增强情绪检测日志**：添加更多情绪检测终端日志输出
- v1.6.19: 本地数据优化
  - **本地数据管理**：实现天气、日程、新闻数据的本地存储与读取，减少重复API调用
- v1.6.20: 异步思考循环集成
  - **异步思考引擎**：插件后台常需不中止地产生思考和日常活动
  - **经历积累**：记录所有对话、事件、成长个技能成长
  - **成长追蹤**：技能、兴趣、观点随时間演化
  - **关系网络**：记住每个用户的互动模式，形成关系
  - **时间感知**：基于时间、天气、节日定时财发内心独白
  - **本地文件保存**：所有思考、活动、经历信息进记录到本地JSON/JSONLファイル
- v1.7.0: 基于情绪的个人资料自动更新功能
  - **自动更换昵称**：根据情绪生成符合当前状态的昵称
  - **自动更换签名**：情绪驱动的个性签名自动更新
  - **自动生成头像**：使用 AI 根据情绪生成真实风格的头像
  - **智能触发机制**：基于情绪强度和冷却时间的智能更新
  - **完整状态管理**：本地保存更新历史和情绪记录
- v1.7.1: 绘图工具调试增强和人格演化系统
  - **完整日志追踪**：绘图工具调用增加详细日志（配置、请求、发送、错误）
  - **人格演化系统**：新增自我认知、表达演进、习惯平衡三大子系统
  - **渐进式演化**：词汇、幽默、句式等随时间自然成长，避免人格突变
  - **变化节奏控制**：14天稳定期 + 7天变化期交替，保持熟悉感与新鲜感平衡
  - **QQ空间诊断工具**：新增三个诊断和配置工具，快速定位问题
  - **回复优化**：修复绘图工具回复格式，确保图文并茂
  - **f-string修复**：修复personality_status命令的Python 3.12下的兼容性问题
- v1.8.0: 代码结构优化，符合AstrBot开发文档规范
  - **生命周期管理**：优化initialize()和terminate()方法，增强资源管理
  - **错误处理**：添加统一的错误处理机制，提高稳定性
  - **代码文档**：完善docstring和类型注释，提高可读性
  - **规范兼容**：全面符合AstrBot插件开发完全指南规范
  - **配置管理**：优化配置读取机制，确保从配置文件加载
  - **异步操作**：确保所有I/O操作使用async/await，避免阻塞
- v1.8.1: 绘画提示词历史记录和对话上下文集成
  - **绘画提示词本地保存**：每次绘画后自动保存原始和增强后的提示词
  - **历史绘画参考**：对话时自动加载最近2天内的3次绘画记录
  - **对话上下文集成**：
    - 发说说时可配置从指定用户的私聊历史生成内容
    - 配图生成时传入对话历史，让图文更一致
    - 支持私聊和群聊两种模式
  - **多源信息融合**：
    - 绘画提示词自动结合人设、天气、日程、穿着信息
    - 根据时间自动调整光线描述
    - 增强日志输出，方便调试对话历史获取
  - **配置增强**：
    - 新增`diary_user_id`配置项，可指定优先使用的对话用户
    - 所有系统提示词支持配置文件自定义
    - 配置页面可预览当天生成的日程
- v1.8.2: 绘画禁止规则可配置
  - **灵活的约束管理**：新增`image_forbidden_rules`配置项
  - **可自定义规则**：支持在配置文件中设置绘画禁止规则
  - **统一应用**：所有绘画场景（QQ空间配图、AI工具调用、手动绘图）都使用同一配置
  - **支持禁用**：留空则完全不添加任何禁止规则
  - **无需改代码**：可直接在配置界面修改，重启AstrBot后生效
- v1.8.3: 实现情绪驱动的Profile自动更新功能
  - **完整实现**：基于情绪强度自动更新QQ昵称、签名和头像
  - **情绪识别**：支持10种情绪类型（开心、悲伤、生气、兴奋等）
  - **智能生成**：根据情绪类型和强度生成相应的昵称、签名和头像提示词
  - **冷却机制**：防止频繁更新，默认30分钟冷却时间
  - **阈值控制**：只有情绪强度超过设定阈值才触发更新
  - **状态管理**：本地存储更新历史和情绪记录
  - **灵活配置**：支持分别启用/禁用昵称、签名、头像更新
  - **AI头像生成**：使用ModelScope API根据情绪生成真实风格头像
- v1.9.0: 新增人生故事引擎 - 自动构建完整经历线同时最小化Token消耗
  - **人生故事引擎**：基于原始人设，使用LLM自动构建完整的人生经历章节
  - **永不修改人设**：原始人设一经设置永不更改，只丰富背景经历
  - **自动收集经历**：从经历银行、思考引擎、事件系统收集最近7天的数据
  - **精简上下文**：将完整故事压缩为<200字的精简提示，最小化Token消耗
  - **缓存机制**：上下文缓存7天，避免重复生成
  - **后台更新**：默认3天更新一次，异步执行不影响当前对话
  - **自动注入**：每次LLM请求时自动将精简上下文注入system_prompt
  - **设计理念**：优先保证扑演质量，其次优化Token，根据实际经历构建故事而非用户习惯
- v1.10.0: 新增独立新闻获取模块 - 多源容错和智能降级
  - **新闻获取模块**：独立的news_getter.py模块，符合AstrBot开发文档规范
  - **多源容错**：支持从百度新闻、必应新闻、通用新闻API获取
  - **智能降级**：如果所有源都失败，自动回退到LLM联网搜索
  - **本地缓存**：JSON格式的新闻数据缓存，避免重复获取
  - **上下文自动注入**：与人生故事引擎集成，每次LLM请求时自动注入新闻上下文

## 致谢

本插件整合了以下插件的功能：
- astrbot_plugin_ms_aiimg (竹和木)
- astrbot_plugin_qzone
